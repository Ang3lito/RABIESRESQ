{% extends "base_patient.html" %}

{% block title %}Reschedule Appointment - RabiesResQ{% endblock %}

{% block content %}
  <div class="flex h-full min-h-0 flex-col space-y-4">
    <div class="flex items-center justify-between border-b border-slate-200 pb-3">
      <div>
        <h1 class="text-2xl font-bold text-slate-900">Reschedule Appointment #{{ appointment.id }}</h1>
        <p class="mt-1 text-sm text-slate-600">
          Current: {{ current_datetime_display or 'N/A' }}
        </p>
      </div>
      <a href="{{ url_for('patient_appointment_view', appointment_id=appointment.id) }}" class="text-xs font-medium text-slate-500 hover:text-slate-700">
        Back to details
      </a>
    </div>

    <div class="grid grid-cols-1 gap-4 lg:grid-cols-3">
      <section class="lg:col-span-2 space-y-4 rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
        <h2 class="text-lg font-semibold text-slate-900">Choose a new date &amp; time</h2>

        <form method="post" action="{{ url_for('patient_appointment_edit', appointment_id=appointment.id) }}" class="space-y-4">
          <input type="hidden" name="appointment_slot_id" id="resched-appointment-slot-id" value="" />

          <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div>
              <label class="mb-2 block text-sm font-semibold text-slate-900">Select date</label>
              <div class="mb-2 flex items-center justify-between">
                <button
                  type="button"
                  id="resched-calendar-prev-month"
                  class="rounded-lg border border-slate-300 bg-white px-3 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50"
                  onclick="reschedPrevCalendarMonth()"
                >
                  Previous
                </button>
                <span id="resched-calendar-month-label" class="flex-1 text-center text-xs font-semibold text-slate-600"></span>
                <button
                  type="button"
                  id="resched-calendar-next-month"
                  class="rounded-lg border border-slate-300 bg-white px-3 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50"
                  onclick="reschedNextCalendarMonth()"
                >
                  Next
                </button>
              </div>
              <div id="resched-availability-calendar" class="grid grid-cols-7 gap-1 rounded-lg border border-slate-200 bg-slate-50 p-3 text-center text-sm">
                <!-- Filled by JS -->
              </div>
              <p id="resched-availability-no-dates" class="mt-2 hidden text-sm text-slate-500">Loading dates...</p>
            </div>

            <div>
              <label class="mb-2 block text-sm font-semibold text-slate-900">Available times</label>
              <div id="resched-availability-times" class="flex flex-wrap gap-2">
                <span id="resched-availability-times-placeholder" class="text-sm text-slate-500">Select a date on the calendar.</span>
              </div>
              <p id="resched-availability-no-slots" class="mt-2 hidden text-sm text-amber-600">No available times. Please contact the clinic or try another date.</p>
              <div id="resched-selected-slot-display" class="mt-2 hidden rounded-lg border border-emerald-200 bg-emerald-50 p-3 text-xs font-medium text-emerald-800"></div>
            </div>
          </div>

          <button
            type="submit"
            class="inline-flex items-center rounded-lg bg-emerald-500 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-600"
          >
            Save new time
          </button>
        </form>
      </section>

      <section class="space-y-3 rounded-xl border border-slate-200 bg-white p-4 shadow-sm text-sm">
        <h2 class="text-lg font-semibold text-slate-900">Summary</h2>
        <p><span class="font-medium text-slate-700">Status:</span> {{ appointment.status or 'Scheduled' }}</p>
        <p><span class="font-medium text-slate-700">Clinic ID:</span> {{ appointment.clinic_id }}</p>
        <p><span class="font-medium text-slate-700">Case ID:</span> {{ appointment.case_id }}</p>
      </section>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    const RESCHED_AVAILABILITY_URL = "{{ url_for('patient_availability') }}";
    const RESCHED_CLINIC_ID = "{{ appointment.clinic_id }}";
    let reschedSlotsByDate = {};
    let reschedCalendarMonthStart = null;

    function reschedBuildCalendar() {
      const calEl = document.getElementById('resched-availability-calendar');
      const noDatesEl = document.getElementById('resched-availability-no-dates');
      if (!calEl || !noDatesEl) return;
      const fromDate = new Date();
      const toDate = new Date();
      toDate.setDate(toDate.getDate() + 60);
      const fromStr = fromDate.toISOString().slice(0, 10);
      const toStr = toDate.toISOString().slice(0, 10);
      const url = RESCHED_AVAILABILITY_URL + '?clinic_id=' + encodeURIComponent(RESCHED_CLINIC_ID) + '&from=' + fromStr + '&to=' + toStr;

      noDatesEl.classList.remove('hidden');
      noDatesEl.textContent = 'Loading dates...';
      calEl.innerHTML = '';

      fetch(url, { credentials: 'same-origin' })
        .then(r => r.json())
        .then(slots => {
          reschedSlotsByDate = {};
          slots.forEach(s => {
            const dt = s.slot_datetime ? s.slot_datetime.slice(0, 10) : '';
            if (!dt) return;
            if (!reschedSlotsByDate[dt]) reschedSlotsByDate[dt] = [];
            reschedSlotsByDate[dt].push(s);
          });
          noDatesEl.classList.add('hidden');
          if (!reschedCalendarMonthStart) {
            const now = new Date();
            reschedCalendarMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
          }
          reschedRenderCalendarGrid(calEl, reschedCalendarMonthStart);
        })
        .catch(() => {
          noDatesEl.textContent = 'Could not load availability. Please try again later.';
        });
    }

    function reschedRenderCalendarGrid(calEl, monthStart) {
      const year = monthStart.getFullYear();
      const month = monthStart.getMonth();
      const first = new Date(year, month, 1);
      const last = new Date(year, month + 1, 0);

      const label = document.getElementById('resched-calendar-month-label');
      if (label) {
        label.textContent = first.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      let html = '';
      const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      weekdays.forEach(w => {
        html += '<div class="text-xs text-slate-500">' + w + '</div>';
      });
      const startDay = first.getDay();
      for (let i = 0; i < startDay; i++) {
        html += '<div></div>';
      }
      for (let day = 1; day <= last.getDate(); day++) {
        const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        const cellDate = new Date(year, month, day);
        const hasSlots = reschedSlotsByDate[dateStr] && reschedSlotsByDate[dateStr].length > 0;
        const isPast = cellDate < today;
        const clickable = hasSlots && !isPast;
        let cls = 'rounded p-1 text-sm ';
        if (clickable) {
          cls += 'cursor-pointer bg-emerald-100 text-emerald-800 hover:bg-emerald-200';
        } else if (isPast) {
          cls += 'text-slate-300';
        } else {
          cls += 'text-slate-500';
        }
        html += '<div class="' + cls + '" data-date="' + dateStr + '" ' +
                (clickable ? 'onclick="reschedOnAvailabilityDateClick(\'' + dateStr + '\')"' : '') +
                '>' + day + '</div>';
      }
      calEl.innerHTML = html;
    }

    function reschedNextCalendarMonth() {
      if (!reschedCalendarMonthStart) {
        const now = new Date();
        reschedCalendarMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      } else {
        reschedCalendarMonthStart = new Date(reschedCalendarMonthStart.getFullYear(), reschedCalendarMonthStart.getMonth() + 1, 1);
      }
      const calEl = document.getElementById('resched-availability-calendar');
      if (calEl) reschedRenderCalendarGrid(calEl, reschedCalendarMonthStart);
    }

    function reschedPrevCalendarMonth() {
      if (!reschedCalendarMonthStart) {
        const now = new Date();
        reschedCalendarMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      } else {
        reschedCalendarMonthStart = new Date(reschedCalendarMonthStart.getFullYear(), reschedCalendarMonthStart.getMonth() - 1, 1);
      }
      const calEl = document.getElementById('resched-availability-calendar');
      if (calEl) reschedRenderCalendarGrid(calEl, reschedCalendarMonthStart);
    }

    function reschedOnAvailabilityDateClick(dateStr) {
      document.querySelectorAll('#resched-availability-calendar [data-date]').forEach(el => {
        el.classList.remove('ring', 'ring-2', 'ring-emerald-500');
      });
      const el = document.querySelector('#resched-availability-calendar [data-date="' + dateStr + '"]');
      if (el) el.classList.add('ring', 'ring-2', 'ring-emerald-500');

      const container = document.getElementById('resched-availability-times');
      const placeholder = document.getElementById('resched-availability-times-placeholder');
      const noSlots = document.getElementById('resched-availability-no-slots');
      const selDisplay = document.getElementById('resched-selected-slot-display');
      const hiddenSlotId = document.getElementById('resched-appointment-slot-id');
      if (!container || !hiddenSlotId) return;

      container.innerHTML = '';
      if (placeholder) placeholder.classList.add('hidden');
      if (noSlots) noSlots.classList.add('hidden');
      if (selDisplay) selDisplay.classList.add('hidden');
      hiddenSlotId.value = '';

      const slots = reschedSlotsByDate[dateStr] || [];
      if (!slots || slots.length === 0) {
        if (noSlots) {
          noSlots.textContent = 'No available times. Please contact the clinic or try another date.';
          noSlots.classList.remove('hidden');
        }
        return;
      }

      slots.forEach(s => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'rounded-lg border-2 border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:border-emerald-500 hover:bg-emerald-50';
        btn.textContent = s.time_display || s.slot_datetime;
        btn.dataset.slotId = s.id;
        btn.addEventListener('click', function() {
          document.querySelectorAll('#resched-availability-times button').forEach(b => {
            b.classList.remove('border-emerald-500', 'bg-emerald-50', 'text-emerald-700');
            b.classList.add('border-slate-300', 'bg-white', 'text-slate-700');
          });
          this.classList.remove('border-slate-300', 'bg-white', 'text-slate-700');
          this.classList.add('border-emerald-500', 'bg-emerald-50', 'text-emerald-700');
          hiddenSlotId.value = this.dataset.slotId || '';
          if (selDisplay) {
            selDisplay.textContent = 'Selected: ' + (s.slot_datetime || s.time_display);
            selDisplay.classList.remove('hidden');
          }
        });
        container.appendChild(btn);
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      reschedBuildCalendar();
    });
  </script>
{% endblock %}

