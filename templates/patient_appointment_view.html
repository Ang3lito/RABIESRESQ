{% extends "base_patient.html" %}

{% block title %}Appointment Details - RabiesResQ{% endblock %}

{% block content %}
  <div class="flex h-full min-h-0 flex-col space-y-4">
    <div class="flex items-center justify-between border-b border-slate-200 pb-3">
      <div>
        <div class="flex flex-wrap items-center gap-3">
          <h1 class="text-2xl font-bold text-slate-900">Appointment #{{ appointment.id }}</h1>
          {% set raw_status = appointment.status or 'Scheduled' %}
          {% set display_status = 'Cancelled' if raw_status in ['Removed', 'Cancelled'] else raw_status %}
          {% if display_status == 'Cancelled' %}
          <span class="inline-flex items-center rounded-full bg-slate-200 px-2.5 py-0.5 text-xs font-medium text-slate-700">
            {{ display_status }}
          </span>
          {% else %}
          <span class="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-700">
            {{ display_status }}
          </span>
          {% endif %}
        </div>
        <p class="mt-1 text-sm text-slate-600">
          <span class="font-medium">For:</span>
          {% set rel = (appointment.victim_relationship or 'Self') %}
          {% if rel|lower == 'self' %}
            Self
          {% else %}
            {{ rel }} - {{ victim_name }}
          {% endif %}
        </p>
      </div>
      <div class="flex items-center">
        <a
          href="{{ url_for('patient_dashboard') }}"
          class="inline-flex items-center rounded-lg border border-slate-200 bg-white px-4 py-2 text-xs font-medium text-slate-700 hover:bg-slate-50 hover:text-slate-900"
        >
          Back to dashboard
        </a>
      </div>
    </div>

    <div class="grid grid-cols-1 gap-4 lg:grid-cols-3">
      <section class="lg:col-span-2 space-y-4 rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
        <h2 class="text-lg font-semibold text-slate-900">Appointment Details</h2>
        <dl class="mt-2 grid grid-cols-1 gap-4 md:grid-cols-2 text-sm">
          <div>
            <dt class="text-slate-500">Date &amp; time</dt>
            <dd class="font-semibold text-slate-900">{{ appt_datetime_display or 'N/A' }}</dd>
          </div>
          <div>
            <dt class="text-slate-500">Type</dt>
            <dd class="font-semibold text-slate-900">{{ appointment.type or 'N/A' }}</dd>
          </div>
          <div>
            <dt class="text-slate-500">Category / Risk level</dt>
            <dd class="font-semibold text-slate-900">{{ appointment.risk_level or 'N/A' }}</dd>
          </div>
          <div>
            <dt class="text-slate-500">Case ID</dt>
            <dd class="font-semibold text-slate-900">{{ appointment.case_id }}</dd>
          </div>
        </dl>

        <h3 class="mt-4 text-sm font-semibold text-slate-900">Victim information</h3>
        <dl class="mt-2 grid grid-cols-1 gap-4 md:grid-cols-2 text-sm">
          <div>
            <dt class="text-slate-500">Name</dt>
            <dd class="font-semibold text-slate-900">{{ victim_name }}</dd>
          </div>
          <div>
            <dt class="text-slate-500">Relationship</dt>
            <dd class="font-semibold text-slate-900">{{ appointment.victim_relationship or 'Self' }}</dd>
          </div>
          <div>
            <dt class="text-slate-500">Contact number</dt>
            <dd class="font-semibold text-slate-900">{{ appointment.phone_number or 'N/A' }}</dd>
          </div>
          <div>
            <dt class="text-slate-500">Address</dt>
            <dd class="font-semibold text-slate-900">{{ appointment.address or 'N/A' }}</dd>
          </div>
        </dl>

        <h3 class="mt-4 text-sm font-semibold text-slate-900">Bite / exposure summary</h3>
        <dl class="mt-2 grid grid-cols-1 gap-4 md:grid-cols-2 text-sm">
          <div>
            <dt class="text-slate-500">Type of exposure</dt>
            <dd class="font-semibold text-slate-900">{{ appointment.type_of_exposure or 'N/A' }}</dd>
          </div>
          <div>
            <dt class="text-slate-500">Date exposed</dt>
            <dd class="font-semibold text-slate-900">{{ appointment.exposure_date or 'N/A' }}</dd>
          </div>
          <div class="md:col-span-2">
            <dt class="text-slate-500">Wound / local treatment</dt>
            <dd class="font-semibold text-slate-900">
              {{ appointment.wound_description or 'No wound description recorded.' }}
              {% if appointment.local_treatment %}
                &mdash; {{ appointment.local_treatment }}
              {% endif %}
            </dd>
          </div>
        </dl>
      </section>

      <section class="space-y-3 rounded-xl border border-slate-200 bg-white p-4 shadow-sm">
        <h2 class="text-lg font-semibold text-slate-900">Actions</h2>
        {% set status_lower = (appointment.status or '')|lower %}
        {% set is_cancelled = status_lower in ['cancelled', 'canceled', 'removed'] %}
        {% set is_completed = status_lower == 'completed' %}
        {% set is_no_show = status_lower in ['no show', 'missed'] %}

        {% if is_completed %}
          <p class="text-xs text-slate-600">
            This appointment has already been completed. No further actions are available.
          </p>
        {% elif is_cancelled %}
          <p class="text-xs text-slate-600">
            This appointment was cancelled. You can remove it from your list if you no longer need to see it.
          </p>
          <form
            method="post"
            action="{{ url_for('patient_hide_appointment', appointment_id=appointment.id) }}"
            onsubmit="return confirm('Remove this appointment from your list?');"
          >
            <button
              type="submit"
              class="mt-1 inline-flex w-full items-center justify-center rounded-lg border border-slate-200 bg-white px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50"
            >
              Remove from list
            </button>
          </form>
        {% elif is_no_show %}
          <p class="text-xs text-slate-600">
            You missed this appointment. You may reschedule it to a new date and time.
          </p>
          <a
            href="{{ url_for('patient_appointment_edit', appointment_id=appointment.id) }}"
            class="inline-flex w-full items-center justify-center rounded-lg bg-emerald-500 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-600"
          >
            Reschedule date &amp; time
          </a>
        {% elif can_edit %}
          <p class="text-xs text-slate-600">
            This appointment is still pending. You can reschedule or cancel it below.
          </p>
          <a
            href="{{ url_for('patient_appointment_edit', appointment_id=appointment.id) }}"
            class="inline-flex w-full items-center justify-center rounded-lg bg-emerald-500 px-4 py-2 text-sm font-medium text-white hover:bg-emerald-600"
          >
            Reschedule date &amp; time
          </a>
          <form
            method="post"
            action="{{ url_for('patient_cancel_appointment', appointment_id=appointment.id) }}"
            onsubmit="return confirm('Cancel this appointment?');"
          >
            <button
              type="submit"
              class="mt-1 inline-flex w-full items-center justify-center rounded-lg border border-red-200 bg-white px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50"
            >
              Cancel appointment
            </button>
          </form>
        {% else %}
          <p class="text-xs text-slate-600">
            This appointment is scheduled. If you can no longer attend, you may cancel it below.
          </p>
          <form
            method="post"
            action="{{ url_for('patient_cancel_appointment', appointment_id=appointment.id) }}"
            onsubmit="return confirm('Cancel this appointment?');"
          >
            <button
              type="submit"
              class="mt-1 inline-flex w-full items-center justify-center rounded-lg border border-red-200 bg-white px-4 py-2 text-sm font-medium text-red-600 hover:bg-red-50"
            >
              Cancel appointment
            </button>
          </form>
        {% endif %}
      </section>
    </div>
  </div>
{% endblock %}

