<!-- Pre-Screening Form Modal -->
<div id="pre-screening-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
  <!-- Backdrop -->
  <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" onclick="closePreScreeningModal()"></div>
  
  <!-- Modal Content -->
  <div class="flex min-h-full items-center justify-center p-4">
    <div class="relative w-full max-w-4xl transform overflow-hidden rounded-xl bg-white shadow-xl transition-all">
      <!-- Header -->
      <div class="sticky top-0 z-10 border-b border-slate-200 bg-white px-6 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-2xl font-bold text-slate-900">Pre-Screening Form</h2>
            <p id="step-indicator" class="mt-1 text-sm text-slate-600">Step 1: Bite Details</p>
          </div>
          <button type="button" onclick="closePreScreeningModal()" class="rounded-lg p-2 text-slate-500 hover:bg-slate-100">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <!-- Progress Bar -->
        <div class="mt-4">
          <div class="h-2 w-full rounded-full bg-slate-200">
            <div id="progress-bar" class="h-2 rounded-full bg-emerald-500 transition-all duration-300" style="width: 33.33%"></div>
          </div>
          <div class="mt-1 flex justify-between text-xs text-slate-500">
            <span id="progress-fraction">1/3</span>
            <span id="progress-text">Step 1 of 3</span>
          </div>
        </div>
      </div>

      <!-- Form Content -->
      <form id="pre-screening-form" method="post" action="{{ url_for('pre_screening_submit') }}" class="px-6 py-6" onsubmit="collectAllFormData()">
        <input type="hidden" name="form_type" id="form-type" value="case">
        
        <!-- Step 1: Bite Details -->
        <div id="step-1" class="step-content">
          <div class="mb-6">
            <h3 class="text-lg font-bold text-slate-900">Bite Details</h3>
            <p class="mt-1 text-sm text-slate-600">Please provide the following information about the incident to help us assess the situation.</p>
          </div>

          <!-- Type of Exposure -->
          <div class="mb-6">
            <label class="mb-2 block text-sm font-semibold text-slate-900">TYPE OF EXPOSURE</label>
            <div class="grid grid-cols-2 gap-3 md:grid-cols-5">
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-3 transition-colors exposure-type" data-value="Bite">
                <input type="radio" name="type_of_exposure" value="Bite" class="sr-only" required>
                <span class="text-sm font-medium">Bite</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-3 transition-colors exposure-type" data-value="Scratch">
                <input type="radio" name="type_of_exposure" value="Scratch" class="sr-only">
                <span class="text-sm font-medium">Scratch</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-3 transition-colors exposure-type" data-value="Contamination of Mucous Membrane">
                <input type="radio" name="type_of_exposure" value="Contamination of Mucous Membrane" class="sr-only">
                <span class="text-sm font-medium text-center">Contamination of Mucous Membrane</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-3 transition-colors exposure-type" data-value="Non-Bite">
                <input type="radio" name="type_of_exposure" value="Non-Bite" class="sr-only">
                <span class="text-sm font-medium">Non-Bite</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-3 transition-colors exposure-type" data-value="Touch only">
                <input type="radio" name="type_of_exposure" value="Touch only" class="sr-only">
                <span class="text-sm font-medium text-center">Touch only / Lick on intact skin</span>
              </label>
            </div>
          </div>

          <!-- Date and Time Exposed -->
          <div class="mb-6 grid grid-cols-1 gap-4 md:grid-cols-2">
            <div>
              <label for="exposure_date" class="mb-2 block cursor-pointer text-sm font-semibold text-slate-900" onclick="document.getElementById('exposure_date').showPicker?.(); document.getElementById('exposure_date').focus();">DATE EXPOSED</label>
              <input type="date" id="exposure_date" name="exposure_date" required class="w-full cursor-pointer rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" onclick="this.showPicker?.()">
            </div>
            <div>
              <label for="exposure_time" class="mb-2 block cursor-pointer text-sm font-semibold text-slate-900" onclick="document.getElementById('exposure_time').showPicker?.(); document.getElementById('exposure_time').focus();">TIME EXPOSED</label>
              <input type="time" id="exposure_time" name="exposure_time" required class="w-full cursor-pointer rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" onclick="this.showPicker?.()">
            </div>
          </div>

          <!-- Place of Exposure and Affected Area -->
          <div class="mb-6 grid grid-cols-1 gap-4 md:grid-cols-2">
            <div>
              <label for="place_of_exposure" class="mb-2 block text-sm font-semibold text-slate-900">PLACE OF EXPOSURE</label>
              <select id="place_of_exposure" name="place_of_exposure" required class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <option value="">Select...</option>
                <option value="Inside home">Inside home</option>
                <option value="Outside home">Outside home</option>
                <option value="Workplace">Workplace</option>
                <option value="School">School</option>
                <option value="Street/Road">Street/Road</option>
                <option value="Park">Park</option>
                <option value="Market/Mall">Market/Mall</option>
                <option value="Farm">Farm</option>
                <option value="Neighbor's house">Neighbor's house</option>
                <option value="Public transport">Public transport</option>
                <option value="Other">Other</option>
              </select>
              <div id="place-of-exposure-other-container" class="mt-3 hidden">
                <label for="place_of_exposure_other" class="mb-2 block text-sm font-medium text-slate-700">Specify other place of exposure</label>
                <input type="text" id="place_of_exposure_other" name="place_of_exposure_other" class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Specify...">
              </div>
            </div>
            <div>
              <label for="affected_area" class="mb-2 block text-sm font-semibold text-slate-900">AFFECTED AREA</label>
              <select id="affected_area" name="affected_area" required class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                <option value="">Select...</option>
                <option value="Head/Face">Head/Face</option>
                <option value="Neck">Neck</option>
                <option value="Trunk">Trunk</option>
                <option value="Right arm">Right arm</option>
                <option value="Left arm">Left arm</option>
                <option value="Right hand">Right hand</option>
                <option value="Left hand">Left hand</option>
                <option value="Right leg">Right leg</option>
                <option value="Left leg">Left leg</option>
                <option value="Right foot">Right foot</option>
                <option value="Left foot">Left foot</option>
                <option value="Other">Other</option>
              </select>
              <div id="affected-area-other-container" class="mt-3 hidden">
                <label for="affected_area_other" class="mb-2 block text-sm font-medium text-slate-700">Specify other affected area</label>
                <input type="text" id="affected_area_other" name="affected_area_other" class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Specify...">
              </div>
            </div>
          </div>

          <!-- Physical Examination Findings -->
          <div class="mb-6">
            <label class="mb-2 block text-sm font-semibold text-slate-900">PHYSICAL EXAMINATION FINDINGS</label>
            
            <!-- Description of Wound -->
            <div class="mb-4">
              <label class="mb-2 block text-sm font-medium text-slate-700">Description of Wound</label>
              <div class="grid grid-cols-2 gap-3 md:grid-cols-5">
                <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-3 py-2.5 transition-colors wound-type" data-value="Punctured">
                  <input type="radio" name="wound_description" value="Punctured" class="sr-only" required>
                  <span class="text-xs font-medium">Punctured</span>
                </label>
                <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-3 py-2.5 transition-colors wound-type" data-value="Abrasion">
                  <input type="radio" name="wound_description" value="Abrasion" class="sr-only">
                  <span class="text-xs font-medium">Abrasion</span>
                </label>
                <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-3 py-2.5 transition-colors wound-type" data-value="Lacerated">
                  <input type="radio" name="wound_description" value="Lacerated" class="sr-only">
                  <span class="text-xs font-medium">Lacerated</span>
                </label>
                <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-3 py-2.5 transition-colors wound-type" data-value="Avulsed">
                  <input type="radio" name="wound_description" value="Avulsed" class="sr-only">
                  <span class="text-xs font-medium">Avulsed</span>
                </label>
                <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-3 py-2.5 transition-colors wound-type" data-value="None">
                  <input type="radio" name="wound_description" value="None" class="sr-only">
                  <span class="text-xs font-medium">None</span>
                </label>
              </div>
            </div>

            <!-- Bleeding -->
            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
              <div>
                <label class="mb-2 block text-sm font-medium text-slate-700">Spontaneous Bleeding</label>
                <div class="flex gap-3">
                  <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-2.5 transition-colors bleeding-spontaneous" data-value="Yes">
                    <input type="radio" name="spontaneous_bleeding" value="Yes" class="sr-only">
                    <span class="text-sm font-medium">Yes</span>
                  </label>
                  <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-2.5 transition-colors bleeding-spontaneous" data-value="No">
                    <input type="radio" name="spontaneous_bleeding" value="No" class="sr-only" checked>
                    <span class="text-sm font-medium">No</span>
                  </label>
                </div>
              </div>
              <div>
                <label class="mb-2 block text-sm font-medium text-slate-700">Induced Bleeding</label>
                <div class="flex gap-3">
                  <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-2.5 transition-colors bleeding-induced" data-value="Yes">
                    <input type="radio" name="induced_bleeding" value="Yes" class="sr-only">
                    <span class="text-sm font-medium">Yes</span>
                  </label>
                  <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-2.5 transition-colors bleeding-induced" data-value="No">
                    <input type="radio" name="induced_bleeding" value="No" class="sr-only" checked>
                    <span class="text-sm font-medium">No</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Previous Anti-Rabies Immunization -->
          <div class="mb-6">
            <label class="mb-2 block text-sm font-semibold text-slate-900">PREVIOUS ANTI-RABIES IMMUNIZATION OF PATIENT</label>
            <div class="grid grid-cols-1 gap-3 md:grid-cols-3">
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-3 transition-colors prev-immunization" data-value="None">
                <input type="radio" name="patient_prev_immunization" value="None" class="sr-only" required>
                <span class="text-sm font-medium">None</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-3 transition-colors prev-immunization" data-value="Completed">
                <input type="radio" name="patient_prev_immunization" value="Completed" class="sr-only">
                <span class="text-sm font-medium">Completed</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-3 transition-colors prev-immunization" data-value="Incomplete">
                <input type="radio" name="patient_prev_immunization" value="Incomplete" class="sr-only">
                <span class="text-sm font-medium">Incomplete</span>
              </label>
            </div>
            <div id="prev-vaccine-date-container" class="mt-4 hidden">
              <label for="prev_vaccine_date" class="mb-2 block text-sm font-medium text-slate-700">Date of Previous Anti-Rabies Vaccine</label>
              <input type="date" id="prev_vaccine_date" name="prev_vaccine_date" class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
            </div>
          </div>

          <!-- Type of Animal -->
          <div class="mb-6">
            <label class="mb-2 block text-sm font-semibold text-slate-900">TYPE OF ANIMAL</label>
            <div class="grid grid-cols-1 gap-3 md:grid-cols-3">
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-3 transition-colors animal-type" data-value="Dog">
                <input type="radio" name="animal_type" value="Dog" class="sr-only" required>
                <span class="text-sm font-medium">Dog</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-3 transition-colors animal-type" data-value="Cat">
                <input type="radio" name="animal_type" value="Cat" class="sr-only">
                <span class="text-sm font-medium">Cat</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-3 transition-colors animal-type" data-value="Others">
                <input type="radio" name="animal_type" value="Others" class="sr-only">
                <span class="text-sm font-medium">Others</span>
              </label>
            </div>
            <div id="other-animal-container" class="mt-4 hidden">
              <label for="other_animal" class="mb-2 block text-sm font-medium text-slate-700">Specify other animal</label>
              <input type="text" id="other_animal" name="other_animal" class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
            </div>
          </div>

          <!-- Animal Status -->
          <div class="mb-6">
            <label class="mb-2 block text-sm font-semibold text-slate-900">ANIMAL STATUS</label>
            <div class="grid grid-cols-2 gap-3 md:grid-cols-5">
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-3 py-2.5 transition-colors animal-status" data-value="Healthy">
                <input type="radio" name="animal_status" value="Healthy" class="sr-only" required>
                <span class="text-xs font-medium">Healthy</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-3 py-2.5 transition-colors animal-status" data-value="Killed">
                <input type="radio" name="animal_status" value="Killed" class="sr-only">
                <span class="text-xs font-medium">Killed</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-3 py-2.5 transition-colors animal-status" data-value="Sick">
                <input type="radio" name="animal_status" value="Sick" class="sr-only">
                <span class="text-xs font-medium">Sick</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-3 py-2.5 transition-colors animal-status" data-value="Lost">
                <input type="radio" name="animal_status" value="Lost" class="sr-only">
                <span class="text-xs font-medium">Lost</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-3 py-2.5 transition-colors animal-status" data-value="Died">
                <input type="radio" name="animal_status" value="Died" class="sr-only">
                <span class="text-xs font-medium">Died</span>
              </label>
            </div>
          </div>

          <!-- Anti-Rabies Vaccination of Animal -->
          <div class="mb-6">
            <label class="mb-2 block text-sm font-semibold text-slate-900">ANTI-RABIES VACCINATION OF ANIMAL</label>
            <div class="grid grid-cols-1 gap-3 md:grid-cols-3">
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-3 transition-colors animal-vaccination" data-value="Updated">
                <input type="radio" name="animal_vaccination" value="Updated" class="sr-only" required>
                <span class="text-sm font-medium">Updated</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-3 transition-colors animal-vaccination" data-value="None">
                <input type="radio" name="animal_vaccination" value="None" class="sr-only">
                <span class="text-sm font-medium">None</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-3 transition-colors animal-vaccination" data-value="Not Updated">
                <input type="radio" name="animal_vaccination" value="Not Updated" class="sr-only">
                <span class="text-sm font-medium">Not Updated</span>
              </label>
            </div>
          </div>

          <!-- Local Wound Treatment -->
          <div class="mb-6">
            <label class="mb-2 block text-sm font-semibold text-slate-900">LOCAL WOUND TREATMENT</label>
            <div class="grid grid-cols-1 gap-3 md:grid-cols-4">
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-3 py-2.5 transition-colors local-treatment" data-value="Wash with Water Only">
                <input type="radio" name="local_treatment" value="Wash with Water Only" class="sr-only" required>
                <span class="text-xs font-medium text-center">Wash with Water Only</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-3 py-2.5 transition-colors local-treatment" data-value="Washed with Water and Soap">
                <input type="radio" name="local_treatment" value="Washed with Water and Soap" class="sr-only">
                <span class="text-xs font-medium text-center">Washed with Water and Soap</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-3 py-2.5 transition-colors local-treatment" data-value="Applied Garlic, etc.">
                <input type="radio" name="local_treatment" value="Applied Garlic, etc." class="sr-only">
                <span class="text-xs font-medium text-center">Applied Garlic, etc.</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-3 py-2.5 transition-colors local-treatment" data-value="Others">
                <input type="radio" name="local_treatment" value="Others" class="sr-only">
                <span class="text-xs font-medium">Others</span>
              </label>
            </div>
            <div id="other-treatment-container" class="mt-4 hidden">
              <label for="other_treatment" class="mb-2 block text-sm font-medium text-slate-700">Specify other treatment</label>
              <input type="text" id="other_treatment" name="other_treatment" class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
            </div>
          </div>

          <!-- Tetanus Immunization -->
          <div class="mb-6">
            <label class="mb-2 block text-sm font-semibold text-slate-900">TETANUS IMMUNIZATION</label>
            <div class="flex gap-3">
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-2.5 transition-colors tetanus-immunization" data-value="Yes">
                <input type="radio" name="tetanus_immunization" value="Yes" class="sr-only" required>
                <span class="text-sm font-medium">Yes</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-2.5 transition-colors tetanus-immunization" data-value="No">
                <input type="radio" name="tetanus_immunization" value="No" class="sr-only">
                <span class="text-sm font-medium">No</span>
              </label>
            </div>
            <div id="tetanus-date-container" class="mt-4 hidden">
              <label for="tetanus_date" class="mb-2 block text-sm font-medium text-slate-700">Date (for Tetanus Immunization)</label>
              <input type="date" id="tetanus_date" name="tetanus_date" class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
            </div>
          </div>

          <!-- Human Tetanus Immunoglobulin -->
          <div class="mb-6">
            <label class="mb-2 block text-sm font-semibold text-slate-900">HUMAN TETANUS IMMUNOGLOBULIN</label>
            <div class="flex gap-3">
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-2.5 transition-colors hrtig-immunization" data-value="Yes">
                <input type="radio" name="hrtig_immunization" value="Yes" class="sr-only" required>
                <span class="text-sm font-medium">Yes</span>
              </label>
              <label class="flex cursor-pointer items-center justify-center rounded-lg border-2 px-4 py-2.5 transition-colors hrtig-immunization" data-value="No">
                <input type="radio" name="hrtig_immunization" value="No" class="sr-only" checked>
                <span class="text-sm font-medium">No</span>
              </label>
            </div>
            <div id="hrtig-date-container" class="mt-4 hidden">
              <label for="hrtig_date" class="mb-2 block text-sm font-medium text-slate-700">HRIG Date</label>
              <input type="date" id="hrtig_date" name="hrtig_date" class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
              <p class="mt-1 text-xs text-slate-500">Required only if HRIG is Yes</p>
            </div>
          </div>
        </div>

        <!-- Step 2: Victim Information -->
        <div id="step-2" class="step-content hidden">
          <div class="mb-6">
            <h3 class="text-lg font-bold text-slate-900">Victim Information</h3>
            <p class="mt-1 text-sm text-slate-600">Please provide the details of the person who was bitten.</p>
          </div>

          <div class="space-y-6">
            <div>
              <label for="relationship_to_user" class="mb-2 block text-sm font-semibold text-slate-900">Relationship to Account User</label>
              <select
                id="relationship_to_user"
                name="relationship_to_user"
                class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
              >
                <option value="Self" selected>Self</option>
                <option value="Child">Child</option>
                <option value="Relative">Relative</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
              <div>
                <label for="victim_first_name" class="mb-2 block text-sm font-semibold text-slate-900">First Name</label>
                <input type="text" id="victim_first_name" name="victim_first_name" value="{{ patient.first_name or '' }}" required class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 placeholder-slate-400 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="First name">
              </div>
              <div>
                <label for="victim_middle_initial" class="mb-2 block text-sm font-semibold text-slate-900">Middle Initial <span class="font-normal text-slate-500">(optional)</span></label>
                <input type="text" id="victim_middle_initial" name="victim_middle_initial" maxlength="2" class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 placeholder-slate-400 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="M.I.">
              </div>
              <div>
                <label for="victim_last_name" class="mb-2 block text-sm font-semibold text-slate-900">Last Name</label>
                <input type="text" id="victim_last_name" name="victim_last_name" value="{{ patient.last_name or '' }}" required class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 placeholder-slate-400 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Last name">
              </div>
            </div>

            <div>
              <label for="age" class="mb-2 block text-sm font-semibold text-slate-900">Age</label>
              <input type="number" id="age" name="age" value="{{ patient.age or '' }}" required class="w-full max-w-xs rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 placeholder-slate-400 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Enter age">
            </div>

            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
              <div>
                <label for="barangay" class="mb-2 block text-sm font-semibold text-slate-900">Barangay</label>
                <select id="barangay" name="barangay" required class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                  <option value="">Select barangay...</option>
                  {% set _addr = patient.address or '' %}
                  {% set _parts = _addr.split(',') %}
                  {% set patient_barangay = _parts[0].strip() if _parts else '' %}
                  <option value="Adlaon" {% if patient_barangay == 'Adlaon' %}selected{% endif %}>Adlaon</option>
                  <option value="Agsungot" {% if patient_barangay == 'Agsungot' %}selected{% endif %}>Agsungot</option>
                  <option value="Apas" {% if patient_barangay == 'Apas' %}selected{% endif %}>Apas</option>
                  {% for b in ['Babag','Bacayan','Banilad','Basak Pardo','Basak San Nicolas','Binaliw','Bonbon','Budlaan','Buhisan','Bulacao','Buot','Busay','Calamba','Cambinocot','Capitol Site','Carreta','Cogon Pardo','Cogon Ramos','Day-as','Duljo Fatima','Ermita','Guadalupe','Guba','Hipodromo','Inayawan','Kalubihan','Kalunasan','Kamagayan','Kamputhaw','Kasambagan','Kinasang-an Pardo','Labangon','Lahug','Lorega San Miguel','Lusaran','Luz','Mabini','Mabolo','Malubog','Mambaling','Pahina Central','Pahina San Nicolas','Pamutan','Pari-an','Paril','Pasil','Pit-os','Poblacion Pardo','Pulangbato','Pung-ol Sibugay','Punta Princesa','Quiot Pardo','Sambag I','Sambag II','San Antonio','San Jose','San Nicolas Proper','San Roque','Santa Cruz','Santo Niño','Sapangdaku','Sawang Calero','Sinsin','Sirao','Suba','Sudlon I','Sudlon II','T. Padilla','Tabunan','Tagba-o','Talamban','Taptap','Tejero','Tinago','Tisa','To-ong','Zapatera'] %}
                  <option value="{{ b }}" {% if patient_barangay == b %}selected{% endif %}>{{ b }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label for="victim_address" class="mb-2 block text-sm font-semibold text-slate-900">Address (Street, Building, etc.)</label>
                <input type="text" id="victim_address" name="victim_address" value="{{ (_parts[1:]|join(', ')) if _parts|length > 1 else (_parts[0].strip() if _parts else '') }}" class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 placeholder-slate-400 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Street, building, house no., etc.">
              </div>
            </div>

            <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
              <div>
                <label for="contact_number" class="mb-2 block text-sm font-semibold text-slate-900">Contact Number</label>
                <input type="tel" id="contact_number" name="contact_number" value="{{ patient.phone_number or '' }}" required class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 placeholder-slate-400 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="e.g., 09123456789">
              </div>
              <div>
                <label for="email_address" class="mb-2 block text-sm font-semibold text-slate-900">Email Address</label>
                <input type="email" id="email_address" name="email_address" value="{{ patient.email or '' }}" required class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 placeholder-slate-400 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Enter email address">
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Choose appointment time (only for New Appointment) -->
        <div id="step-3" class="step-content hidden" data-step-appointment-only="true">
          <div class="mb-6">
            <h3 class="text-lg font-bold text-slate-900">Choose appointment time</h3>
            <p class="mt-1 text-sm text-slate-600">Select a date, then a time. Only available slots are shown.</p>
          </div>
          <input type="hidden" name="appointment_slot_id" id="appointment_slot_id" value="" />
          <input type="hidden" name="appointment_datetime" id="appointment_datetime" value="" />
          <input type="hidden" name="clinic_id" id="clinic_id_slot" value="{{ clinics[0].id if clinics and clinics|length == 1 else '' }}" />
          {% if clinics and clinics|length > 1 %}
          <div class="mb-4">
            <label for="clinic_select" class="mb-2 block text-sm font-semibold text-slate-900">Clinic</label>
            <select id="clinic_select" class="w-full rounded-lg border border-slate-300 bg-slate-50 px-4 py-2.5 text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
              {% for c in clinics %}
              <option value="{{ c.id }}" {% if loop.first %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
          {% endif %}
          <div class="mb-4">
            <label class="mb-2 block text-sm font-semibold text-slate-900">Select date</label>
            <div class="mb-2 flex items-center justify-between">
              <button
                type="button"
                id="calendar-prev-month"
                class="rounded-lg border border-slate-300 bg-white px-3 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50"
                onclick="prevCalendarMonth()"
              >
                Previous
              </button>
              <span id="calendar-month-label" class="flex-1 text-center text-xs font-semibold text-slate-600"></span>
              <button
                type="button"
                id="calendar-next-month"
                class="rounded-lg border border-slate-300 bg-white px-3 py-1 text-xs font-medium text-slate-700 hover:bg-slate-50"
                onclick="nextCalendarMonth()"
              >
                Next
              </button>
            </div>
            <div id="availability-calendar" class="grid grid-cols-7 gap-1 rounded-lg border border-slate-200 bg-slate-50 p-3 text-center text-sm">
              <!-- Filled by JS -->
            </div>
            <p id="availability-no-dates" class="mt-2 hidden text-sm text-slate-500">Loading dates...</p>
          </div>
          <div class="mb-4">
            <label class="mb-2 block text-sm font-semibold text-slate-900">Available times for selected date</label>
            <div id="availability-times" class="flex flex-wrap gap-2">
              <span id="availability-times-placeholder" class="text-sm text-slate-500">Select a date above.</span>
            </div>
            <p id="availability-no-slots" class="mt-2 hidden text-sm text-amber-600">No available times. Please contact the clinic or try another date.</p>
          </div>
          <div id="selected-slot-display" class="hidden rounded-lg border border-emerald-200 bg-emerald-50 p-3 text-sm font-medium text-emerald-800"></div>
        </div>

        <!-- Step 4: Summary -->
        <div id="step-4" class="step-content hidden">
          <div class="mb-6">
            <h3 class="text-lg font-bold text-slate-900">Pre-Screening Summary</h3>
            <p class="mt-1 text-sm text-slate-600">Please review the information below before submitting.</p>
          </div>

          <div id="summary-content" class="space-y-6">
            <!-- Summary will be populated by JavaScript -->
          </div>
          
          <!-- Info Message -->
          <div class="mt-6 rounded-lg border-2 border-amber-200 bg-amber-50 p-4">
            <div class="flex items-start gap-3">
              <div class="flex h-6 w-6 shrink-0 items-center justify-center rounded-full bg-amber-500 text-white">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
              </div>
              <div>
                <p class="text-sm font-semibold text-amber-800">Reminder</p>
                <p class="mt-1 text-sm text-amber-700">Please bring a valid ID and arrive 10–15 minutes before your scheduled time. If you have any questions, contact the clinic directly.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="mt-8 flex justify-end gap-3 border-t border-slate-200 pt-6">
          <button type="button" id="back-btn" onclick="previousStep()" class="hidden rounded-lg border-2 border-slate-300 bg-white px-6 py-2.5 text-sm font-medium text-slate-700 hover:bg-slate-50">Back</button>
          <button type="button" id="next-btn" onclick="nextStep()" class="rounded-lg bg-emerald-500 px-6 py-2.5 text-sm font-medium text-white hover:bg-emerald-600">Next</button>
          <button type="submit" id="submit-btn" class="hidden rounded-lg bg-emerald-500 px-6 py-2.5 text-sm font-medium text-white hover:bg-emerald-600">Submit & Continue to Dashboard</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
let currentStep = 1;
let totalSteps = 3;
let formData = {};
let isAppointmentFlow = false;
const AVAILABILITY_URL = "{{ url_for('patient_availability') }}";
let calendarMonthStart = null;

function openPreScreeningModal(formType = 'case') {
  document.getElementById('pre-screening-modal').classList.remove('hidden');
  document.getElementById('form-type').value = formType;
  isAppointmentFlow = (formType === 'appointment');
  totalSteps = isAppointmentFlow ? 4 : 3;
  currentStep = 1;
  formData = {};
  document.getElementById('appointment_slot_id').value = '';
  document.getElementById('appointment_datetime').value = '';
  var clinicSlot = document.getElementById('clinic_id_slot');
  if (clinicSlot && document.getElementById('clinic_select')) {
    clinicSlot.value = document.getElementById('clinic_select').value;
  }
  showStep(1);
  document.body.style.overflow = 'hidden';
  initializeRadioButtons();
  if (isAppointmentFlow) {
    buildCalendar();
  }
}

function initializeRadioButtons() {
  // Initialize all radio button labels with default styling
  const radioGroups = ['exposure-type', 'wound-type', 'bleeding-spontaneous', 'bleeding-induced', 'prev-immunization', 'animal-type', 'animal-status', 'animal-vaccination', 'local-treatment', 'tetanus-immunization', 'hrtig-immunization'];
  
  radioGroups.forEach(groupClass => {
    document.querySelectorAll('.' + groupClass).forEach(label => {
      const radio = label.querySelector('input[type="radio"]');
      if (radio) {
        // Set default styling
        label.classList.remove('border-emerald-500', 'bg-emerald-50', 'text-emerald-700');
        label.classList.add('border-slate-300', 'bg-white', 'text-slate-900');
        
        // If checked, apply selected styling
        if (radio.checked) {
          label.classList.remove('border-slate-300', 'bg-white', 'text-slate-900');
          label.classList.add('border-emerald-500', 'bg-emerald-50', 'text-emerald-700');
        }
      }
    });
  });
}

function closePreScreeningModal() {
  document.getElementById('pre-screening-modal').classList.add('hidden');
  document.body.style.overflow = 'auto';
  currentStep = 1;
  formData = {};
  document.getElementById('pre-screening-form').reset();
  showStep(1);
  // Clear red validation highlights from option buttons and inputs
  const optionGroups = ['exposure-type', 'wound-type', 'bleeding-spontaneous', 'bleeding-induced', 'prev-immunization', 'animal-type', 'animal-status', 'animal-vaccination', 'local-treatment', 'tetanus-immunization', 'hrtig-immunization'];
  optionGroups.forEach(cls => {
    document.querySelectorAll('.' + cls).forEach(l => l.classList.remove('border-red-500'));
  });
  document.querySelectorAll('#pre-screening-form input, #pre-screening-form select').forEach(f => f.classList.remove('border-red-500'));
}

function getStepDivId(step) {
  if (totalSteps === 3 && step === 3) return 'step-4';
  return 'step-' + step;
}

function getStepName(step) {
  const names4 = ['', 'Bite Details', 'Victim Info', 'Choose appointment time', 'Summary'];
  const names3 = ['', 'Bite Details', 'Victim Info', 'Summary'];
  const names = totalSteps === 4 ? names4 : names3;
  return names[step] || '';
}

function showStep(step) {
  document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
  var stepDivId = getStepDivId(step);
  var el = document.getElementById(stepDivId);
  if (el) el.classList.remove('hidden');

  const progress = (step / totalSteps) * 100;
  document.getElementById('progress-bar').style.width = progress + '%';
  document.getElementById('progress-fraction').textContent = step + '/' + totalSteps;
  document.getElementById('step-indicator').textContent = 'Step ' + step + ': ' + getStepName(step);
  document.getElementById('progress-text').textContent = 'Step ' + step + ' of ' + totalSteps;

  document.getElementById('back-btn').classList.toggle('hidden', step === 1);
  document.getElementById('next-btn').classList.toggle('hidden', step === totalSteps);
  document.getElementById('submit-btn').classList.toggle('hidden', step !== totalSteps);

  initializeRadioButtons();
  if (isAppointmentFlow && step === 3) {
    var sel = document.getElementById('clinic_select');
    if (sel) document.getElementById('clinic_id_slot').value = sel.value;
  }
}

function goToStep(step) {
  currentStep = step;
  if (step === totalSteps) {
    populateSummary();
  }
  showStep(step);
}

function nextStep() {
  if (validateStep(currentStep)) {
    collectStepData(currentStep);
    if (currentStep < totalSteps) {
      currentStep++;
      if (currentStep === totalSteps) {
        populateSummary();
      }
      showStep(currentStep);
      if (isAppointmentFlow && currentStep === 3) {
        buildCalendar();
      }
    }
  }
}

function previousStep() {
  if (currentStep > 1) {
    currentStep--;
    showStep(currentStep);
  }
}

function validateStep(step) {
  var stepDivId = getStepDivId(step);
  const stepElement = document.getElementById(stepDivId);
  if (!stepElement) return true;

  if (isAppointmentFlow && step === 3) {
    var slotId = document.getElementById('appointment_slot_id');
    var slotDt = document.getElementById('appointment_datetime');
    if (!slotId || !slotDt || !slotId.value || !slotDt.value) {
      showAlert('Please select a date and time for your appointment.');
      return false;
    }
    return true;
  }

  // Clear all validation highlights first
  const optionGroups = ['exposure-type', 'wound-type', 'bleeding-spontaneous', 'bleeding-induced', 'prev-immunization', 'animal-type', 'animal-status', 'animal-vaccination', 'local-treatment', 'tetanus-immunization', 'hrtig-immunization'];
  optionGroups.forEach(cls => {
    stepElement.querySelectorAll('.' + cls).forEach(l => l.classList.remove('border-red-500'));
  });
  stepElement.querySelectorAll('input, select').forEach(f => f.classList.remove('border-red-500'));

  const requiredFields = stepElement.querySelectorAll('[required]');
  let isValid = true;
  const invalidRadioGroups = new Set();
  requiredFields.forEach(field => {
    let fieldValid = true;
    if (field.type === 'radio') {
      fieldValid = !!stepElement.querySelector(`[name="${field.name}"]:checked`);
      if (!fieldValid) invalidRadioGroups.add(field.name);
    } else {
      fieldValid = !!field.value || field.value === '0';
      if (!fieldValid) field.classList.add('border-red-500');
    }
    if (!fieldValid) isValid = false;
  });
  // Highlight option buttons (labels) in red for invalid radio groups
  invalidRadioGroups.forEach(name => {
    stepElement.querySelectorAll(`[name="${name}"]`).forEach(radio => {
      const label = radio.closest('label');
      if (label) {
        label.classList.remove('border-slate-300');
        label.classList.add('border-red-500');
      }
    });
  });
  if (!isValid) {
    showAlert('Please fill in all required fields.');
  }
  return isValid;
}

function collectStepData(step) {
  const stepElement = document.getElementById(`step-${step}`);
  const inputs = stepElement.querySelectorAll('input, select, textarea');
  inputs.forEach(input => {
    if (input.type === 'radio') {
      if (input.checked) {
        formData[input.name] = input.value;
      }
    } else {
      formData[input.name] = input.value;
    }
  });
}

function collectAllFormData() {
  collectStepData(1);
  collectStepData(2);
  if (isAppointmentFlow) {
    var cs = document.getElementById('clinic_select');
    if (cs) document.getElementById('clinic_id_slot').value = cs.value;
  }
  const form = document.getElementById('pre-screening-form');
  const allInputs = form.querySelectorAll('input, select, textarea');
  allInputs.forEach(input => {
    if (input.type === 'radio') {
      if (input.checked && formData[input.name] !== input.value) {
        formData[input.name] = input.value;
      }
    } else if (input.type !== 'hidden' && input.name) {
      if (formData[input.name] === undefined) {
        formData[input.name] = input.value;
      }
    }
  });
  return true;
}

function computeRiskCategoryFromForm(data) {
  const typeOfExposure = (data.type_of_exposure || '').trim();
  const affectedArea = (data.affected_area || '').trim();
  const woundDescription = (data.wound_description || '').trim();
  const animalStatus = (data.animal_status || '').trim();
  const animalVaccination = (data.animal_vaccination || '').trim();
  const prevImmunization = (data.patient_prev_immunization || '').trim();

  const spontaneous = (data.spontaneous_bleeding || 'No').trim();
  const induced = (data.induced_bleeding || 'No').trim();

  let bleedingType = 'None';
  if (spontaneous === 'Yes' && induced === 'Yes') {
    bleedingType = 'Both spontaneous and induced';
  } else if (spontaneous === 'Yes') {
    bleedingType = 'Spontaneous';
  } else if (induced === 'Yes') {
    bleedingType = 'Induced';
  }

  // Store for later display if needed
  data.bleeding_type = bleedingType;

  const highRiskExposures = ['Bite', 'Contamination of Mucous Membrane'];
  const highRiskAreas = ['Head/Face', 'Neck'];
  const severeWounds = ['Punctured', 'Lacerated', 'Avulsed'];
  const highRiskAnimalStatus = ['Sick', 'Died', 'Lost'];

  if (
    highRiskExposures.includes(typeOfExposure) ||
    highRiskAreas.includes(affectedArea) ||
    bleedingType === 'Spontaneous' ||
    bleedingType === 'Both spontaneous and induced' ||
    severeWounds.includes(woundDescription) ||
    highRiskAnimalStatus.includes(animalStatus)
  ) {
    return 'Category III';
  }

  if (
    typeOfExposure === 'Scratch' ||
    typeOfExposure === 'Non-Bite' ||
    woundDescription === 'Abrasion' ||
    bleedingType === 'Induced'
  ) {
    return 'Category II';
  }

  return 'Category I';
}

function formatAppointmentDisplay(isoStr) {
  if (!isoStr) return 'N/A';
  try {
    var d = new Date(isoStr);
    var opts = { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' };
    return d.toLocaleDateString('en-US', opts);
  } catch (e) {
    return isoStr;
  }
}

function populateSummary() {
  collectStepData(1);
  collectStepData(2);
  if (isAppointmentFlow) {
    var dtEl = document.getElementById('appointment_datetime');
    formData.appointment_datetime = dtEl ? dtEl.value : '';
  }

  const riskCategory = computeRiskCategoryFromForm(formData);
  let riskColor = '#10B981';
  if (riskCategory === 'Category III') {
    riskColor = '#FA5053';
  } else if (riskCategory === 'Category II') {
    riskColor = '#FFB343';
  }

  var appointmentBlock = '';
  if (isAppointmentFlow && formData.appointment_datetime) {
    appointmentBlock = `
    <div class="rounded-lg border border-slate-200 bg-slate-50 p-5">
      <div class="mb-4 flex items-center justify-between">
        <h4 class="text-base font-bold text-slate-900">Appointment</h4>
        <button type="button" onclick="goToStep(3)" class="text-sm font-medium text-emerald-600 hover:text-emerald-700">Edit</button>
      </div>
      <p class="text-xs text-slate-500">Date &amp; time</p>
      <p class="font-semibold text-slate-900">${formatAppointmentDisplay(formData.appointment_datetime)}</p>
    </div>
    `;
  }

  const summaryContent = document.getElementById('summary-content');
  summaryContent.innerHTML = `
    <div class="rounded-lg border border-slate-200 bg-slate-50 p-5">
      <div class="mb-4 flex items-center justify-between">
        <h4 class="text-base font-bold text-slate-900">Patient Information</h4>
        <button type="button" onclick="goToStep(2)" class="text-sm font-medium text-emerald-600 hover:text-emerald-700">Edit</button>
      </div>
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
        <div>
          <p class="text-xs text-slate-500">Name</p>
          <p class="font-semibold text-slate-900">${[formData.victim_first_name, formData.victim_middle_initial, formData.victim_last_name].filter(Boolean).join(' ') || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Age</p>
          <p class="font-semibold text-slate-900">${formData.age || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Contact Number</p>
          <p class="font-semibold text-slate-900">${formData.contact_number || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Email Address</p>
          <p class="font-semibold text-slate-900">${formData.email_address || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Barangay</p>
          <p class="font-semibold text-slate-900">${formData.barangay || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Address</p>
          <p class="font-semibold text-slate-900">${formData.victim_address || 'N/A'}</p>
        </div>
      </div>
    </div>
    ${appointmentBlock}
    <div class="rounded-lg border border-slate-200 bg-slate-50 p-5">
      <div class="mb-4 flex items-center justify-between">
        <h4 class="text-base font-bold text-slate-900">Bite Details</h4>
        <button type="button" onclick="goToStep(1)" class="text-sm font-medium text-emerald-600 hover:text-emerald-700">Edit</button>
      </div>
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
        <div class="md:col-span-2">
          <p class="text-xs text-slate-500">Risk Category</p>
          <p class="font-semibold" style="color: ${riskColor};">${riskCategory}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Type of Exposure</p>
          <p class="font-semibold text-slate-900">${formData.type_of_exposure || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Type of Animal</p>
          <p class="font-semibold text-slate-900">${formData.animal_type || 'N/A'}${formData.other_animal ? ' (' + formData.other_animal + ')' : ''}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Animal Status</p>
          <p class="font-semibold text-slate-900">${formData.animal_status || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Date Exposed</p>
          <p class="font-semibold text-slate-900">${formData.exposure_date || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Time Exposed</p>
          <p class="font-semibold text-slate-900">${formData.exposure_time || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Place of Exposure</p>
          <p class="font-semibold text-slate-900">${formData.place_of_exposure || 'N/A'}${formData.place_of_exposure_other ? ' (' + formData.place_of_exposure_other + ')' : ''}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Affected Area</p>
          <p class="font-semibold text-slate-900">${formData.affected_area || 'N/A'}${formData.affected_area_other ? ' (' + formData.affected_area_other + ')' : ''}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Prev Anti-Rabies Immunization</p>
          <p class="font-semibold text-slate-900">${formData.patient_prev_immunization || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Date of Prev Vaccine</p>
          <p class="font-semibold text-slate-900">${formData.prev_vaccine_date || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Anti-Rabies Vaccination of Animal</p>
          <p class="font-semibold text-slate-900">${formData.animal_vaccination || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Physical Examination Findings</p>
          <p class="font-semibold text-slate-900">${formData.wound_description || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Local Wound Treatment</p>
          <p class="font-semibold text-slate-900">${formData.local_treatment || 'N/A'}${formData.other_treatment ? ' (' + formData.other_treatment + ')' : ''}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Tetanus Immunization</p>
          <p class="font-semibold text-slate-900">${formData.tetanus_immunization || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Date (for Tetanus Immunization)</p>
          <p class="font-semibold text-slate-900">${formData.tetanus_date || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">Human Tetanus Immunoglobulin</p>
          <p class="font-semibold text-slate-900">${formData.hrtig_immunization || 'N/A'}</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">HRIG Date</p>
          <p class="font-semibold text-slate-900">${formData.hrtig_date || 'N/A'}</p>
        </div>
      </div>
    </div>
  `;
}

var slotsByDate = {};

function getClinicIdForAvailability() {
  var sel = document.getElementById('clinic_select');
  if (sel) return sel.value;
  var hid = document.getElementById('clinic_id_slot');
  return hid ? hid.value : '';
}

function buildCalendar() {
  var calEl = document.getElementById('availability-calendar');
  var noDatesEl = document.getElementById('availability-no-dates');
  if (!calEl) return;
  var clinicId = getClinicIdForAvailability();
  var fromDate = new Date();
  var toDate = new Date();
  toDate.setDate(toDate.getDate() + 60);
  var fromStr = fromDate.toISOString().slice(0, 10);
  var toStr = toDate.toISOString().slice(0, 10);
  var url = AVAILABILITY_URL + '?clinic_id=' + encodeURIComponent(clinicId) + '&from=' + fromStr + '&to=' + toStr;
  noDatesEl.classList.remove('hidden');
  noDatesEl.textContent = 'Loading dates...';
  calEl.innerHTML = '';
  fetch(url, { credentials: 'same-origin' })
    .then(function(r) { return r.json(); })
    .then(function(slots) {
      slotsByDate = {};
      slots.forEach(function(s) {
        var dt = s.slot_datetime ? s.slot_datetime.slice(0, 10) : '';
        if (dt) {
          if (!slotsByDate[dt]) slotsByDate[dt] = [];
          slotsByDate[dt].push(s);
        }
      });
      noDatesEl.classList.add('hidden');
      if (!calendarMonthStart) {
        var now = new Date();
        calendarMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
      }
      renderCalendarGrid(calEl, calendarMonthStart);
    })
    .catch(function() {
      noDatesEl.textContent = 'Could not load availability. Try again later.';
    });
}

function renderCalendarGrid(calEl, monthStart) {
  var year = monthStart.getFullYear();
  var month = monthStart.getMonth();

  var first = new Date(year, month, 1);
  var last = new Date(year, month + 1, 0);

  var label = document.getElementById('calendar-month-label');
  if (label) {
    label.textContent = first.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  }

  var today = new Date();
  today.setHours(0, 0, 0, 0);
  var html = '';
  var weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  weekdays.forEach(function(w) {
    html += '<div class="text-xs text-slate-500">' + w + '</div>';
  });
  var startDay = first.getDay();
  for (var i = 0; i < startDay; i++) {
    html += '<div></div>';
  }
  for (var day = 1; day <= last.getDate(); day++) {
    var dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
    var cellDate = new Date(year, month, day);
    var hasSlots = slotsByDate[dateStr] && slotsByDate[dateStr].length > 0;
    var isPast = cellDate < today;
    var clickable = hasSlots && !isPast;
    var cls = 'rounded p-1 text-sm ';
    if (clickable) {
      cls += 'cursor-pointer bg-emerald-100 text-emerald-800 hover:bg-emerald-200';
    } else if (isPast) {
      cls += 'text-slate-300';
    } else {
      cls += 'text-slate-500';
    }
    html += '<div class="' + cls + '" data-date="' + dateStr + '" ' + (clickable ? 'onclick="onAvailabilityDateClick(\'' + dateStr + '\')"' : '') + '>' + day + '</div>';
  }
  calEl.innerHTML = html;
}

function nextCalendarMonth() {
  if (!calendarMonthStart) {
    var now = new Date();
    calendarMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  } else {
    calendarMonthStart = new Date(calendarMonthStart.getFullYear(), calendarMonthStart.getMonth() + 1, 1);
  }
  var calEl = document.getElementById('availability-calendar');
  if (calEl) {
    renderCalendarGrid(calEl, calendarMonthStart);
  }
}

function prevCalendarMonth() {
  if (!calendarMonthStart) {
    var now = new Date();
    calendarMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  } else {
    calendarMonthStart = new Date(calendarMonthStart.getFullYear(), calendarMonthStart.getMonth() - 1, 1);
  }
  var calEl = document.getElementById('availability-calendar');
  if (calEl) {
    renderCalendarGrid(calEl, calendarMonthStart);
  }
}

function onAvailabilityDateClick(dateStr) {
  document.querySelectorAll('#availability-calendar [data-date]').forEach(function(el) {
    el.classList.remove('ring', 'ring-2', 'ring-emerald-500');
  });
  var el = document.querySelector('#availability-calendar [data-date="' + dateStr + '"]');
  if (el) el.classList.add('ring', 'ring-2', 'ring-emerald-500');
  var container = document.getElementById('availability-times');
  var placeholder = document.getElementById('availability-times-placeholder');
  var noSlots = document.getElementById('availability-no-slots');
  var selDisplay = document.getElementById('selected-slot-display');
  // If core elements are missing, do nothing to avoid JS errors
  if (!container || !noSlots) {
    return;
  }
  container.innerHTML = '';
  if (placeholder) {
    placeholder.classList.add('hidden');
  }
  if (selDisplay) {
    selDisplay.classList.add('hidden');
  }
  noSlots.classList.add('hidden');
  document.getElementById('appointment_slot_id').value = '';
  document.getElementById('appointment_datetime').value = '';
  // Use preloaded slotsByDate so every green date always shows its times
  var slots = slotsByDate[dateStr] || [];
  if (!slots || slots.length === 0) {
    noSlots.textContent = 'No available times. Please contact the clinic or try another date.';
    noSlots.classList.remove('hidden');
    return;
  }

  slots.forEach(function(s) {
    var btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'rounded-lg border-2 border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 hover:border-emerald-500 hover:bg-emerald-50';
    btn.textContent = s.time_display;
    btn.dataset.slotId = s.id;
    btn.dataset.slotDatetime = s.slot_datetime || '';
    btn.addEventListener('click', function() {
      document.querySelectorAll('#availability-times button').forEach(function(b) {
        b.classList.remove('border-emerald-500', 'bg-emerald-50', 'text-emerald-700');
        b.classList.add('border-slate-300', 'bg-white', 'text-slate-700');
      });
      this.classList.remove('border-slate-300', 'bg-white', 'text-slate-700');
      this.classList.add('border-emerald-500', 'bg-emerald-50', 'text-emerald-700');
      document.getElementById('appointment_slot_id').value = this.dataset.slotId || '';
      document.getElementById('appointment_datetime').value = this.dataset.slotDatetime || '';
      selDisplay.textContent = 'Selected: ' + (s.slot_datetime ? formatAppointmentDisplay(s.slot_datetime) : s.time_display);
      selDisplay.classList.remove('hidden');
    });
    container.appendChild(btn);
  });
}

// Radio button styling
document.addEventListener('DOMContentLoaded', function() {
  var clinicSelect = document.getElementById('clinic_select');
  if (clinicSelect) {
    clinicSelect.addEventListener('change', function() {
      document.getElementById('clinic_id_slot').value = this.value;
      if (typeof buildCalendar === 'function') buildCalendar();
    });
  }

  // Handle radio button visual selection
  const radioGroups = ['exposure-type', 'wound-type', 'bleeding-spontaneous', 'bleeding-induced', 'prev-immunization', 'animal-type', 'animal-status', 'animal-vaccination', 'local-treatment', 'tetanus-immunization', 'hrtig-immunization'];
  
  radioGroups.forEach(groupClass => {
    document.querySelectorAll('.' + groupClass).forEach(label => {
      const radio = label.querySelector('input[type="radio"]');
      if (radio) {
        // Initialize styling
        if (!radio.checked) {
          label.classList.add('border-slate-300', 'bg-white', 'text-slate-900');
        }
        
        radio.addEventListener('change', function() {
          // Remove selected state and validation red from siblings
          document.querySelectorAll('.' + groupClass).forEach(l => {
            l.classList.remove('border-emerald-500', 'bg-emerald-50', 'text-emerald-700', 'border-red-500');
            l.classList.add('border-slate-300', 'bg-white', 'text-slate-900');
          });
          // Add selected state to current
          if (this.checked) {
            label.classList.remove('border-slate-300', 'bg-white', 'text-slate-900', 'border-red-500');
            label.classList.add('border-emerald-500', 'bg-emerald-50', 'text-emerald-700');
          }
        });
      }
    });
  });

  // Clear validation red when user fills in inputs/selects
  document.querySelectorAll('#pre-screening-form input:not([type="radio"]), #pre-screening-form select').forEach(el => {
    el.addEventListener('input', function() { this.classList.remove('border-red-500'); });
    el.addEventListener('change', function() { this.classList.remove('border-red-500'); });
  });

  // Conditional field visibility
  document.querySelectorAll('input[name="patient_prev_immunization"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const container = document.getElementById('prev-vaccine-date-container');
      if (this.value === 'Completed' || this.value === 'Incomplete') {
        container.classList.remove('hidden');
      } else {
        container.classList.add('hidden');
      }
    });
  });

  document.querySelectorAll('input[name="animal_type"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const container = document.getElementById('other-animal-container');
      if (this.value === 'Others') {
        container.classList.remove('hidden');
      } else {
        container.classList.add('hidden');
      }
    });
  });

  document.querySelectorAll('input[name="local_treatment"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const container = document.getElementById('other-treatment-container');
      if (this.value === 'Others') {
        container.classList.remove('hidden');
      } else {
        container.classList.add('hidden');
      }
    });
  });

  document.querySelectorAll('input[name="tetanus_immunization"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const container = document.getElementById('tetanus-date-container');
      if (this.value === 'Yes') {
        container.classList.remove('hidden');
      } else {
        container.classList.add('hidden');
      }
    });
  });

  document.querySelectorAll('input[name="hrtig_immunization"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const container = document.getElementById('hrtig-date-container');
      const dateInput = document.getElementById('hrtig_date');
      if (this.value === 'Yes') {
        container.classList.remove('hidden');
        if (dateInput) dateInput.required = true;
      } else {
        container.classList.add('hidden');
        if (dateInput) {
          dateInput.required = false;
          dateInput.value = '';
        }
      }
    });
  });

  var placeSelect = document.getElementById('place_of_exposure');
  var placeOtherContainer = document.getElementById('place-of-exposure-other-container');
  var placeOtherInput = document.getElementById('place_of_exposure_other');
  if (placeSelect && placeOtherContainer && placeOtherInput) {
    placeSelect.addEventListener('change', function() {
      if (this.value === 'Other') {
        placeOtherContainer.classList.remove('hidden');
        placeOtherInput.required = true;
      } else {
        placeOtherContainer.classList.add('hidden');
        placeOtherInput.required = false;
        placeOtherInput.value = '';
      }
    });
  }

  var affectedSelect = document.getElementById('affected_area');
  var affectedOtherContainer = document.getElementById('affected-area-other-container');
  var affectedOtherInput = document.getElementById('affected_area_other');
  if (affectedSelect && affectedOtherContainer && affectedOtherInput) {
    affectedSelect.addEventListener('change', function() {
      if (this.value === 'Other') {
        affectedOtherContainer.classList.remove('hidden');
        affectedOtherInput.required = true;
      } else {
        affectedOtherContainer.classList.add('hidden');
        affectedOtherInput.required = false;
        affectedOtherInput.value = '';
      }
    });
  }
});
</script>
